# =============================================================================
# Adelaide Weather System - Production Nginx Security Configuration
# =============================================================================
# 
# Hardened nginx configuration with enhanced security measures for production
# deployment. This configuration implements defense-in-depth security controls.
#
# Security Features:
# - Modern TLS configuration with strong ciphers
# - Comprehensive security headers (HSTS, CSP, etc.)
# - Advanced rate limiting and DDoS protection
# - Request validation and filtering
# - Security monitoring and logging
# =============================================================================

# Worker process optimization for security
worker_processes auto;
worker_rlimit_nofile 65535;

# Security: Limit worker processes if under attack
worker_rlimit_core 0;
worker_priority -5;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
    accept_mutex off;
}

http {
    # =============================================================================
    # BASIC SECURITY CONFIGURATION
    # =============================================================================
    
    # Hide nginx version and server information
    server_tokens off;
    server_name_in_redirect off;
    port_in_redirect off;
    
    # Security headers for all responses
    more_set_headers "Server: Adelaide-Weather";
    more_set_headers "X-Powered-By: ";
    
    # =============================================================================
    # MIME TYPES AND CONTENT HANDLING
    # =============================================================================
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    charset utf-8;
    
    # =============================================================================
    # ENHANCED LOGGING FOR SECURITY MONITORING
    # =============================================================================
    
    log_format security_extended '$remote_addr - $remote_user [$time_local] '
                                '"$request" $status $body_bytes_sent '
                                '"$http_referer" "$http_user_agent" '
                                '"$http_x_forwarded_for" '
                                'rt=$request_time uct="$upstream_connect_time" '
                                'uht="$upstream_header_time" urt="$upstream_response_time" '
                                'upstream="$upstream_addr" cache="$upstream_cache_status" '
                                'ssl_protocol="$ssl_protocol" ssl_cipher="$ssl_cipher" '
                                'request_id="$request_id" client_country="$geoip2_data_country_iso"';
    
    # JSON format for structured logging and SIEM integration
    log_format json_security escape=json
        '{'
        '"timestamp":"$time_iso8601",'
        '"request_id":"$request_id",'
        '"remote_addr":"$remote_addr",'
        '"remote_user":"$remote_user",'
        '"request_method":"$request_method",'
        '"request_uri":"$request_uri",'
        '"server_protocol":"$server_protocol",'
        '"status":$status,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"request_time":$request_time,'
        '"upstream_response_time":"$upstream_response_time",'
        '"upstream_addr":"$upstream_addr",'
        '"ssl_protocol":"$ssl_protocol",'
        '"ssl_cipher":"$ssl_cipher",'
        '"user_agent":"$http_user_agent",'
        '"referer":"$http_referer",'
        '"x_forwarded_for":"$http_x_forwarded_for",'
        '"country":"$geoip2_data_country_iso"'
        '}';
    
    access_log /var/log/nginx/access.log security_extended;
    access_log /var/log/nginx/security.log json_security;
    error_log /var/log/nginx/error.log warn;
    
    # =============================================================================
    # PERFORMANCE WITH SECURITY CONSIDERATIONS
    # =============================================================================
    
    # File I/O optimization
    sendfile on;
    sendfile_max_chunk 512k;
    tcp_nopush on;
    tcp_nodelay on;
    
    # Connection handling with security limits
    keepalive_timeout 65;
    keepalive_requests 100;  # Reduced from 1000 for security
    client_header_timeout 10s;
    client_body_timeout 10s;
    send_timeout 10s;
    reset_timedout_connection on;
    
    # Security-focused buffer limits
    client_body_buffer_size 1m;
    client_header_buffer_size 1k;
    client_max_body_size 10m;  # Strict limit to prevent DoS
    large_client_header_buffers 4 8k;
    
    # =============================================================================
    # ADVANCED RATE LIMITING AND DDOS PROTECTION
    # =============================================================================
    
    # Geographic rate limiting zones
    limit_req_zone $binary_remote_addr zone=api_critical:10m rate=5r/s;
    limit_req_zone $binary_remote_addr zone=api_moderate:10m rate=15r/s;
    limit_req_zone $binary_remote_addr zone=frontend:10m rate=30r/s;
    limit_req_zone $binary_remote_addr zone=monitoring:5m rate=2r/s;
    
    # Per-IP connection limiting
    limit_conn_zone $binary_remote_addr zone=perip:10m;
    limit_conn_zone $server_name zone=perserver:10m;
    
    # Request size and rate limiting
    limit_rate_after 1m;
    limit_rate 250k;
    
    # =============================================================================
    # SSL/TLS SECURITY CONFIGURATION
    # =============================================================================
    
    # Modern TLS configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    # SSL session optimization
    ssl_session_cache shared:SSL:50m;
    ssl_session_timeout 24h;
    ssl_session_tickets off;
    
    # SSL security features
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/nginx/ssl/ca-bundle.crt;
    
    # Diffie-Hellman parameters for PFS
    ssl_dhparam /etc/nginx/ssl/dhparam.pem;
    
    # =============================================================================
    # COMPREHENSIVE SECURITY HEADERS MAP
    # =============================================================================
    
    map $uri $content_security_policy {
        default "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' fonts.googleapis.com; img-src 'self' data: blob:; connect-src 'self'; font-src 'self' fonts.gstatic.com; object-src 'none'; media-src 'self'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests;";
        ~^/api/ "default-src 'none'; frame-ancestors 'none';";
        ~^/health "default-src 'none'; frame-ancestors 'none';";
    }
    
    # =============================================================================
    # UPSTREAM DEFINITIONS WITH SECURITY
    # =============================================================================
    
    upstream api_backend_secure {
        least_conn;
        server api:8000 weight=1 max_fails=3 fail_timeout=30s;
        
        keepalive 16;  # Reduced for security
        keepalive_requests 100;
        keepalive_timeout 60s;
    }
    
    upstream frontend_backend_secure {
        server frontend:3000 weight=1 max_fails=3 fail_timeout=30s;
        
        keepalive 8;
        keepalive_requests 50;
        keepalive_timeout 60s;
    }
    
    # =============================================================================
    # GeoIP SECURITY (Optional - requires GeoIP2 module)
    # =============================================================================
    
    # Uncomment if GeoIP2 module is available
    # geoip2 /etc/nginx/GeoLite2-Country.mmdb {
    #     $geoip2_data_country_iso country iso_code;
    #     $geoip2_data_country_name country names en;
    # }
    
    # Block traffic from specific countries (example)
    # map $geoip2_data_country_iso $blocked_country {
    #     default 0;
    #     CN 1;  # Block China
    #     RU 1;  # Block Russia
    # }
    
    # =============================================================================
    # HTTP TO HTTPS REDIRECT WITH SECURITY
    # =============================================================================
    
    server {
        listen 80;
        server_name _;
        
        # Security headers for redirects
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        
        # Health check endpoint (HTTP only)
        location = /health {
            access_log off;
            return 200 "nginx healthy\n";
            add_header Content-Type text/plain;
        }
        
        # ACME challenge for Let's Encrypt
        location ^~ /.well-known/acme-challenge/ {
            root /var/www/certbot;
            try_files $uri =404;
        }
        
        # Redirect all other HTTP traffic to HTTPS
        location / {
            return 301 https://$host$request_uri;
        }
    }
    
    # =============================================================================
    # MAIN HTTPS SERVER WITH ADVANCED SECURITY
    # =============================================================================
    
    server {
        listen 443 ssl http2;
        server_name your-production-domain.com;  # Replace with actual domain
        
        # SSL Certificate configuration
        ssl_certificate /etc/nginx/ssl/fullchain.pem;
        ssl_certificate_key /etc/nginx/ssl/privkey.pem;
        
        # Security headers
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
        add_header Content-Security-Policy $content_security_policy always;
        add_header Feature-Policy "geolocation 'none'; microphone 'none'; camera 'none'" always;
        
        # Security connection limits
        limit_conn perip 10;
        limit_conn perserver 1000;
        
        # Request ID for tracking
        add_header X-Request-ID $request_id always;
        
        # =============================================================================
        # SECURITY FILTERING AND VALIDATION
        # =============================================================================
        
        # Block suspicious user agents
        if ($http_user_agent ~* (nmap|nikto|wikto|sf|sqlmap|bsqlbf|w3af|acunetix|havij|appscan|python-requests)) {
            return 444;
        }
        
        # Block empty user agents
        if ($http_user_agent = "") {
            return 444;
        }
        
        # Block suspicious request methods
        if ($request_method !~ ^(GET|HEAD|POST|PUT|DELETE|OPTIONS)$) {
            return 405;
        }
        
        # Geographic blocking (if GeoIP enabled)
        # if ($blocked_country) {
        #     return 444;
        # }
        
        # =============================================================================
        # API ROUTES WITH ENHANCED SECURITY
        # =============================================================================
        
        location /api/ {
            # Strict rate limiting for API
            limit_req zone=api_critical burst=10 nodelay;
            
            # Remove /api prefix before forwarding
            rewrite ^/api/(.*) /$1 break;
            
            # Enhanced proxy configuration
            proxy_pass http://api_backend_secure;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Request-ID $request_id;
            
            # Security timeouts
            proxy_connect_timeout 5s;
            proxy_send_timeout 10s;
            proxy_read_timeout 10s;
            
            # Hide upstream errors
            proxy_intercept_errors on;
            error_page 502 503 504 = @api_error;
            
            # Disable caching for API responses
            add_header Cache-Control "no-cache, no-store, must-revalidate" always;
            add_header Pragma "no-cache" always;
        }
        
        location @api_error {
            return 503 '{"error": "Service temporarily unavailable", "request_id": "$request_id"}';
            add_header Content-Type application/json;
            add_header X-Request-ID $request_id always;
        }
        
        # =============================================================================
        # FRONTEND ROUTES WITH SECURITY
        # =============================================================================
        
        location / {
            # Rate limiting for frontend
            limit_req zone=frontend burst=30 nodelay;
            
            # Proxy to frontend service
            proxy_pass http://frontend_backend_secure;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Request-ID $request_id;
            
            # Security timeouts
            proxy_connect_timeout 10s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Error handling
            proxy_intercept_errors on;
            error_page 502 503 504 = @frontend_error;
        }
        
        location @frontend_error {
            return 503 "Service temporarily unavailable";
            add_header Content-Type text/plain;
            add_header X-Request-ID $request_id always;
        }
        
        # =============================================================================
        # MONITORING ENDPOINTS WITH ACCESS CONTROL
        # =============================================================================
        
        # Grafana - restricted access
        location /grafana/ {
            # Allow only internal networks and admin IPs
            allow 172.20.0.0/16;  # Internal Docker network
            allow 172.21.0.0/16;  # Monitoring network
            allow 10.0.0.0/8;     # Private network
            allow 192.168.0.0/16; # Private network
            # allow YOUR_ADMIN_IP;  # Add specific admin IPs
            deny all;
            
            limit_req zone=monitoring burst=5 nodelay;
            
            rewrite ^/grafana/?(.*) /$1 break;
            proxy_pass http://grafana:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Prometheus - highly restricted
        location /prometheus/ {
            # Allow only localhost and specific admin IPs
            allow 127.0.0.1;
            allow 172.21.0.0/16;  # Monitoring network only
            deny all;
            
            limit_req zone=monitoring burst=2 nodelay;
            
            rewrite ^/prometheus/?(.*) /$1 break;
            proxy_pass http://prometheus:9090;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        # =============================================================================
        # SECURITY MEASURES AND ATTACK MITIGATION
        # =============================================================================
        
        # Block access to sensitive files
        location ~ /\.(ht|git|svn|env) {
            deny all;
            return 404;
        }
        
        location ~ \.(php|asp|aspx|jsp|cgi|pl)$ {
            deny all;
            return 404;
        }
        
        # Block backup and temporary files
        location ~ \.(bak|backup|swp|tmp|log)$ {
            deny all;
            return 404;
        }
        
        # Block suspicious URLs
        location ~* (eval\(|base64_|etc/passwd|proc/self/environ|boot\.ini) {
            return 444;
        }
        
        # Block shell shock and other attacks
        location ~* (bash|cmd|exec|system|eval) {
            return 444;
        }
        
        # =============================================================================
        # HEALTH CHECK ENDPOINTS
        # =============================================================================
        
        location = /health {
            access_log off;
            return 200 "nginx healthy\n";
            add_header Content-Type text/plain;
            add_header X-Request-ID $request_id always;
        }
        
        # =============================================================================
        # STATIC ASSET HANDLING WITH SECURITY
        # =============================================================================
        
        location /static/ {
            alias /var/www/static/;
            
            # Security headers for static content
            add_header X-Content-Type-Options "nosniff" always;
            add_header Cache-Control "public, max-age=31536000, immutable" always;
            
            # Efficient file serving
            try_files $uri =404;
            access_log off;
        }
        
        # CSS, JavaScript, and other assets
        location ~* \.(css|js|ico|png|jpg|jpeg|gif|svg|woff|woff2|ttf|eot)$ {
            expires 30d;
            add_header Cache-Control "public, no-transform" always;
            add_header X-Content-Type-Options "nosniff" always;
            access_log off;
        }
    }
}

# =============================================================================
# CONFIGURATION NOTES FOR PRODUCTION DEPLOYMENT
# =============================================================================
#
# 1. SSL CERTIFICATES:
#    - Replace paths with actual certificate locations
#    - Use Let's Encrypt: certbot --nginx -d your-domain.com
#    - Generate dhparam: openssl dhparam -out /etc/nginx/ssl/dhparam.pem 2048
#
# 2. DOMAIN CONFIGURATION:
#    - Replace "your-production-domain.com" with actual domain
#    - Update CORS_ORIGINS in application configuration
#
# 3. IP ACCESS CONTROL:
#    - Add specific admin IP addresses to monitoring endpoints
#    - Configure firewall rules for additional protection
#
# 4. RATE LIMITING:
#    - Adjust rate limits based on expected traffic
#    - Monitor and tune based on attack patterns
#
# 5. LOGGING:
#    - Configure log rotation: logrotate
#    - Ship logs to centralized logging system (ELK, Splunk)
#    - Set up alerting for security events
#
# 6. GeoIP (Optional):
#    - Install GeoIP2 module and database
#    - Configure country-based blocking if needed
#
# 7. MONITORING:
#    - Set up Prometheus metrics for nginx
#    - Configure alerts for high error rates
#    - Monitor certificate expiration
#
# 8. TESTING:
#    - Test with SSL Labs: https://www.ssllabs.com/ssltest/
#    - Security scan: nmap, nikto, OWASP ZAP
#    - Load testing: ab, siege, wrk
#
# =============================================================================