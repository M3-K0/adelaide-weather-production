#!/bin/bash
# =============================================================================
# Adelaide Weather System - Emergency Security Fix Script
# =============================================================================
# 
# This script implements immediate security fixes for critical vulnerabilities
# identified in the security audit. Run this script IMMEDIATELY before any
# production deployment.
#
# CRITICAL VULNERABILITIES ADDRESSED:
# 1. Replace hardcoded API tokens with secure random tokens
# 2. Enable Redis authentication with strong password  
# 3. Remove API token from frontend configuration
# 4. Rotate administrative credentials
# 5. Enable enhanced security features
#
# Usage:
#   chmod +x emergency_security_fix.sh
#   ./emergency_security_fix.sh
#
# Prerequisites:
# - Docker and docker-compose installed
# - Write access to configuration files
# - openssl command available
# =============================================================================

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
BACKUP_DIR="${PROJECT_ROOT}/security_backup_$(date +%Y%m%d_%H%M%S)"

echo -e "${RED}============================================================================="
echo -e "Adelaide Weather System - EMERGENCY SECURITY FIX"
echo -e "=============================================================================${NC}"
echo -e "${YELLOW}WARNING: This script will make critical security changes to your system."
echo -e "A backup will be created before making any changes.${NC}"
echo ""

# Confirmation prompt
read -p "Are you sure you want to proceed? (type 'YES' to continue): " CONFIRM
if [ "$CONFIRM" != "YES" ]; then
    echo -e "${RED}Operation cancelled.${NC}"
    exit 1
fi

echo -e "${BLUE}Creating backup directory: ${BACKUP_DIR}${NC}"
mkdir -p "$BACKUP_DIR"

# =============================================================================
# STEP 1: BACKUP EXISTING CONFIGURATION
# =============================================================================
echo -e "\n${BLUE}Step 1: Backing up existing configuration files...${NC}"

backup_file() {
    local file="$1"
    if [ -f "$file" ]; then
        echo "  Backing up: $file"
        cp "$file" "$BACKUP_DIR/$(basename "$file").backup"
    else
        echo "  File not found: $file (skipping)"
    fi
}

backup_file "${PROJECT_ROOT}/.env"
backup_file "${PROJECT_ROOT}/.env.production" 
backup_file "${PROJECT_ROOT}/frontend/next.config.js"
backup_file "${PROJECT_ROOT}/docker-compose.production.yml"

echo -e "${GREEN}✓ Backup completed in: ${BACKUP_DIR}${NC}"

# =============================================================================
# STEP 2: GENERATE SECURE CREDENTIALS
# =============================================================================
echo -e "\n${BLUE}Step 2: Generating secure credentials...${NC}"

# Generate cryptographically secure credentials
echo "  Generating API token..."
NEW_API_TOKEN=$(openssl rand -base64 32 | tr -d '\n')

echo "  Generating Redis password..."
NEW_REDIS_PASSWORD=$(openssl rand -base64 24 | tr -d '\n')

echo "  Generating Grafana admin password..."
NEW_GRAFANA_PASSWORD=$(openssl rand -base64 24 | tr -d '\n')

echo "  Generating Grafana secret key..."
NEW_GRAFANA_SECRET_KEY=$(openssl rand -base64 32 | tr -d '\n')

echo -e "${GREEN}✓ Secure credentials generated${NC}"

# =============================================================================
# STEP 3: FIX HARDCODED API TOKENS
# =============================================================================
echo -e "\n${BLUE}Step 3: Fixing hardcoded API tokens...${NC}"

# Create secure .env.production
cat > "${PROJECT_ROOT}/.env.production" << EOF
# Adelaide Weather Forecasting System - Secure Production Environment
# Generated by emergency security fix on $(date)

# =============================================================================
# SECURITY-HARDENED CONFIGURATION
# =============================================================================

# API Authentication (SECURE RANDOM TOKEN)
API_TOKEN=${NEW_API_TOKEN}

# =============================================================================
# BUILD AND VERSION INFORMATION
# =============================================================================
VERSION=1.0.0
BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
VCS_REF=main

# =============================================================================
# SECURITY AND ACCESS CONTROL
# =============================================================================
CORS_ORIGINS=https://your-production-domain.com
TRUSTED_HOSTS=your-production-domain.com,*.your-production-domain.com

# Redis Security (SECURE RANDOM PASSWORD)
REDIS_PASSWORD=${NEW_REDIS_PASSWORD}

# Grafana Security (SECURE RANDOM CREDENTIALS)
GRAFANA_PASSWORD=${NEW_GRAFANA_PASSWORD}
GRAFANA_SECRET_KEY=${NEW_GRAFANA_SECRET_KEY}

# =============================================================================
# PERFORMANCE AND MONITORING - SECURITY OPTIMIZED
# =============================================================================
LOG_LEVEL=INFO
RATE_LIMIT_PER_MINUTE=30
RATE_LIMIT_ENABLED=true
COMPRESSION_ENABLED=true
COMPRESSION_MIN_SIZE=500
NGINX_COMPRESSION=true
PERFORMANCE_CACHE_TTL=300
PROMETHEUS_ENABLED=true
MONITORING_ENABLED=true
METRICS_COLLECTION_INTERVAL=30
CONFIG_DRIFT_REALTIME_ENABLED=true

# =============================================================================
# INFRASTRUCTURE CONFIGURATION
# =============================================================================
NGINX_HOST=localhost
REDIS_ENABLED=true
TOKEN_ROTATION_ENABLED=true
TOKEN_ROTATION_INTERVAL_HOURS=24

# External services (optional)
WEATHER_API_KEY=
WEATHER_API_ENABLED=false

# =============================================================================
# SECURITY NOTICE
# =============================================================================
# This configuration was secured on $(date)
# All credentials are cryptographically random
# Replace NGINX_HOST and CORS_ORIGINS with your actual domain before deployment
# =============================================================================
EOF

# Update main .env file
cat > "${PROJECT_ROOT}/.env" << EOF
# Adelaide Weather Forecasting System - Local Development
# Secured API token for development use

API_TOKEN=${NEW_API_TOKEN}
EOF

echo -e "${GREEN}✓ Environment files updated with secure tokens${NC}"

# =============================================================================
# STEP 4: REMOVE API TOKEN FROM FRONTEND
# =============================================================================
echo -e "\n${BLUE}Step 4: Removing API token from frontend configuration...${NC}"

# Create secure next.config.js
cat > "${PROJECT_ROOT}/frontend/next.config.js" << 'EOF'
/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'standalone',
  webpack: (config, { isServer }) => {
    // Exclude Node.js modules from client-side bundle
    if (!isServer) {
      config.resolve.fallback = {
        ...config.resolve.fallback,
        cluster: false,
        os: false,
        fs: false,
        child_process: false,
        worker_threads: false,
        perf_hooks: false,
        v8: false,
        process: false,
        dgram: false,
        http2: false,
        tls: false,
        net: false,
        async_hooks: false,
      };
      
      // Exclude server-only modules from client bundle
      config.externals = config.externals || [];
      config.externals.push('prom-client');
    }
    return config;
  },
  env: {
    // SECURITY FIX: Removed API_TOKEN from client-side environment
    // API authentication is now handled server-side only
    API_BASE_URL: process.env.API_BASE_URL || 'http://localhost:8000'
  },
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'X-Frame-Options',
            value: 'DENY'
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff'
          },
          {
            key: 'Referrer-Policy',
            value: 'strict-origin-when-cross-origin'
          },
          {
            key: 'Permissions-Policy',
            value: 'camera=(), microphone=(), geolocation=()'
          },
          {
            key: 'X-XSS-Protection',
            value: '1; mode=block'
          },
          {
            key: 'Strict-Transport-Security',
            value: 'max-age=31536000; includeSubDomains'
          }
        ]
      }
    ];
  },
  async rewrites() {
    return [
      {
        source: '/api/:path*',
        destination: `${process.env.API_BASE_URL || 'http://localhost:8000'}/:path*`
      }
    ];
  },
  images: {
    domains: []
  },
  typescript: {
    // SECURITY: Enable strict type checking in production
    ignoreBuildErrors: false
  },
  eslint: {
    // SECURITY: Enable linting in production builds
    ignoreDuringBuilds: false
  },
  poweredByHeader: false
};

module.exports = nextConfig;
EOF

echo -e "${GREEN}✓ Frontend configuration secured (API token removed)${NC}"

# =============================================================================
# STEP 5: UPDATE DOCKER COMPOSE CONFIGURATION
# =============================================================================
echo -e "\n${BLUE}Step 5: Updating Docker Compose for Redis security...${NC}"

# Update Redis configuration in docker-compose.production.yml
if [ -f "${PROJECT_ROOT}/docker-compose.production.yml" ]; then
    # Create a temporary file with updated Redis configuration
    python3 - << EOF
import yaml
import os

compose_file = "${PROJECT_ROOT}/docker-compose.production.yml"

with open(compose_file, 'r') as f:
    compose = yaml.safe_load(f)

# Update Redis service to require authentication
if 'services' in compose and 'redis' in compose['services']:
    redis_service = compose['services']['redis']
    
    # Update command to require password
    redis_service['command'] = """redis-server 
--requirepass \${REDIS_PASSWORD}
--appendonly yes 
--maxmemory 512mb 
--maxmemory-policy allkeys-lru
--save 900 1 
--save 300 10 
--save 60 10000"""
    
    # Remove external port exposure for security
    if 'ports' in redis_service:
        del redis_service['ports']
    
    # Add security labels
    if 'labels' not in redis_service:
        redis_service['labels'] = []
    redis_service['labels'].append('com.adelaide-weather.security=hardened')

# Write updated configuration
with open(compose_file, 'w') as f:
    yaml.dump(compose, f, default_flow_style=False, sort_keys=False)

print("✓ Docker Compose configuration updated")
EOF
else
    echo -e "${YELLOW}Warning: docker-compose.production.yml not found${NC}"
fi

# =============================================================================
# STEP 6: CREATE SECURE STARTUP SCRIPT
# =============================================================================
echo -e "\n${BLUE}Step 6: Creating secure startup script...${NC}"

cat > "${PROJECT_ROOT}/start_secure.sh" << EOF
#!/bin/bash
# Adelaide Weather System - Secure Startup Script
# Generated by emergency security fix on $(date)

set -euo pipefail

echo "Starting Adelaide Weather System with security hardening..."

# Verify environment configuration
echo "Verifying security configuration..."

if grep -q "demo-token" .env.production 2>/dev/null; then
    echo "ERROR: Demo token still present in configuration!"
    exit 1
fi

if [ -z "\${REDIS_PASSWORD:-}" ]; then
    echo "ERROR: Redis password not configured!"
    exit 1
fi

# Start services with security hardening
echo "Starting services..."
docker-compose -f docker-compose.production.yml down || true
docker-compose -f docker-compose.production.yml up -d

# Wait for services to be ready
echo "Waiting for services to be ready..."
sleep 30

# Verify services are running
docker-compose -f docker-compose.production.yml ps

echo ""
echo "============================================================================="
echo "Adelaide Weather System started with security hardening"
echo "============================================================================="
echo "API Endpoint: https://your-domain.com/api/"
echo "Health Check: https://your-domain.com/health"  
echo "Grafana: https://your-domain.com/grafana/ (admin / [generated-password])"
echo ""
echo "IMPORTANT NEXT STEPS:"
echo "1. Replace 'your-domain.com' with your actual domain in .env.production"
echo "2. Obtain SSL certificates: certbot --nginx -d your-domain.com"
echo "3. Test all endpoints with the new authentication token"
echo "4. Monitor logs for any authentication issues"
echo "============================================================================="
EOF

chmod +x "${PROJECT_ROOT}/start_secure.sh"

# =============================================================================
# STEP 7: CREATE CREDENTIALS SUMMARY
# =============================================================================
echo -e "\n${BLUE}Step 7: Creating credentials summary...${NC}"

cat > "${BACKUP_DIR}/SECURE_CREDENTIALS.txt" << EOF
Adelaide Weather System - Secure Credentials
Generated: $(date)

CRITICAL: Store these credentials in a secure password manager immediately!

=============================================================================
API AUTHENTICATION TOKEN:
${NEW_API_TOKEN}

REDIS PASSWORD:
${NEW_REDIS_PASSWORD}

GRAFANA ADMIN PASSWORD:
${NEW_GRAFANA_PASSWORD}

GRAFANA SECRET KEY:
${NEW_GRAFANA_SECRET_KEY}
=============================================================================

SECURITY NOTES:
1. These credentials replace the weak defaults in your system
2. The API token is now cryptographically secure (256-bit entropy)
3. Redis is now protected with authentication
4. All credentials should be rotated every 30-90 days
5. Never commit these credentials to version control

NEXT STEPS:
1. Store credentials in secure password manager
2. Update your production domain in .env.production
3. Obtain SSL certificates for your domain
4. Test all services with new credentials
5. Delete this file after securing credentials

=============================================================================
EOF

# Secure the credentials file
chmod 600 "${BACKUP_DIR}/SECURE_CREDENTIALS.txt"

# =============================================================================
# FINAL SUMMARY AND INSTRUCTIONS
# =============================================================================
echo -e "\n${GREEN}============================================================================="
echo -e "EMERGENCY SECURITY FIX COMPLETED SUCCESSFULLY"
echo -e "=============================================================================${NC}"
echo ""
echo -e "${GREEN}✓ Hardcoded API tokens replaced with secure random tokens"
echo -e "✓ Redis authentication enabled with strong password"  
echo -e "✓ API token removed from frontend configuration"
echo -e "✓ Administrative credentials rotated to secure values"
echo -e "✓ Enhanced security features enabled${NC}"
echo ""
echo -e "${YELLOW}CRITICAL NEXT STEPS:${NC}"
echo -e "1. ${BLUE}Secure the credentials:${NC}"
echo -e "   cat ${BACKUP_DIR}/SECURE_CREDENTIALS.txt"
echo -e "   # Store in password manager, then delete file"
echo ""
echo -e "2. ${BLUE}Update domain configuration:${NC}"
echo -e "   # Edit .env.production and replace:"
echo -e "   # NGINX_HOST=your-actual-domain.com"
echo -e "   # CORS_ORIGINS=https://your-actual-domain.com"
echo ""
echo -e "3. ${BLUE}Obtain SSL certificates:${NC}"
echo -e "   sudo certbot --nginx -d your-actual-domain.com"
echo ""
echo -e "4. ${BLUE}Start the secure system:${NC}"
echo -e "   ./start_secure.sh"
echo ""
echo -e "5. ${BLUE}Test the security fixes:${NC}"
echo -e "   # Test API with new token"
echo -e "   curl -H \"Authorization: Bearer \${NEW_API_TOKEN}\" https://your-domain.com/api/health"
echo ""
echo -e "${RED}IMPORTANT SECURITY REMINDERS:${NC}"
echo -e "• Never commit the new .env files to version control"
echo -e "• Rotate credentials every 30-90 days"  
echo -e "• Monitor authentication logs for suspicious activity"
echo -e "• Set up alerts for failed authentication attempts"
echo -e "• Run security scans regularly"
echo ""
echo -e "${GREEN}Your Adelaide Weather system is now significantly more secure!${NC}"
echo -e "${GREEN}Backup created in: ${BACKUP_DIR}${NC}"
echo ""
echo -e "============================================================================="
EOF

chmod +x emergency_security_fix.sh

echo -e "${GREEN}✓ Emergency security fix script created successfully${NC}"
echo -e "${BLUE}Location: /home/micha/adelaide-weather-final/security_configs/emergency_security_fix.sh${NC}"