# Adelaide Weather System - Secure Redis Configuration
# Production-ready Redis configuration with security hardening
#
# Usage: Mount this config in Redis container
# docker run -v $(pwd)/redis-secure.conf:/etc/redis/redis.conf redis:7-alpine

# =============================================================================
# SECURITY CONFIGURATION
# =============================================================================

# Require authentication (CRITICAL)
# Set password via environment variable in production
requirepass ${REDIS_PASSWORD}

# Disable dangerous commands
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG ""
rename-command DEBUG ""
rename-command EVAL ""
rename-command SHUTDOWN ""

# Access Control Lists (Redis 6.0+)
# Create limited user for application access
user default off nopass ~* &* -@all
user adelaide on >${REDIS_PASSWORD} ~* &* +@read +@write +@string +@hash +@list +@set +@stream +@pubsub +ping +info +client

# =============================================================================
# NETWORK SECURITY
# =============================================================================

# Bind to internal network only (not exposed externally)
bind 127.0.0.1 172.20.0.0/16
protected-mode yes

# Default port (change if needed for additional security)
port 6379

# Disable external connections
tcp-backlog 511
tcp-keepalive 300

# =============================================================================
# PERSISTENCE AND BACKUP SECURITY
# =============================================================================

# Enable AOF for better durability
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# RDB snapshots (encrypted backups recommended in production)
save 900 1
save 300 10
save 60 10000

# Secure file permissions
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb

# =============================================================================
# MEMORY MANAGEMENT
# =============================================================================

# Memory limit and eviction policy
maxmemory 512mb
maxmemory-policy allkeys-lru

# =============================================================================
# LOGGING AND MONITORING
# =============================================================================

# Log level for security monitoring
loglevel notice
logfile ""  # Use Docker logging

# Enable slow log for performance monitoring
slowlog-log-slower-than 10000
slowlog-max-len 128

# =============================================================================
# CLIENT MANAGEMENT AND RATE LIMITING
# =============================================================================

# Connection limits
maxclients 10000
timeout 300

# Rate limiting
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# =============================================================================
# TLS/SSL CONFIGURATION (Optional - for encrypted connections)
# =============================================================================

# Uncomment and configure for TLS connections
# port 0
# tls-port 6380
# tls-cert-file /etc/redis/tls/redis.crt
# tls-key-file /etc/redis/tls/redis.key
# tls-ca-cert-file /etc/redis/tls/ca.crt
# tls-protocols "TLSv1.2 TLSv1.3"

# =============================================================================
# SECURITY MODULES (Redis 7.0+)
# =============================================================================

# Enable Redis security features
# loadmodule /usr/lib/redis/modules/redisecurity.so

# =============================================================================
# PRODUCTION NOTES
# =============================================================================
#
# 1. PASSWORDS:
#    - Use strong random passwords (min 32 characters)
#    - Rotate passwords regularly (every 30-90 days)
#    - Store passwords in secure secret management system
#
# 2. NETWORK:
#    - Never expose Redis directly to internet
#    - Use VPN or private networks for admin access
#    - Consider Redis Sentinel for high availability
#
# 3. MONITORING:
#    - Monitor slow queries and memory usage
#    - Set up alerts for authentication failures
#    - Track connection patterns for anomaly detection
#
# 4. BACKUPS:
#    - Encrypt backups at rest and in transit
#    - Test backup restoration procedures
#    - Store backups in separate security domain
#
# 5. COMPLIANCE:
#    - Configure audit logging if required
#    - Implement data retention policies
#    - Document access controls for SOC 2
#
# =============================================================================