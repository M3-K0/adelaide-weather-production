name: Pull Request Quality Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]

env:
  NODE_VERSION: '18.17.0'

jobs:
  quality-check:
    name: Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Fetch full history for better diff analysis
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            **/*.{js,jsx,ts,tsx}
            **/*.json
            **/*.md

      - name: Run linting on changed files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Changed files: ${{ steps.changed-files.outputs.all_changed_files }}"
          npx eslint ${{ steps.changed-files.outputs.all_changed_files }} --ext .js,.jsx,.ts,.tsx

      - name: Run Prettier check on changed files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          npx prettier --check ${{ steps.changed-files.outputs.all_changed_files }}

      - name: Type check
        run: npm run type-check

      - name: Run affected tests
        run: |
          # Run tests for changed files
          npm run test -- --findRelatedTests ${{ steps.changed-files.outputs.all_changed_files }} --coverage

      - name: Comment PR with results
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');

            // Read coverage summary if available
            let coverageComment = '';
            try {
              const coverage = JSON.parse(fs.readFileSync('./coverage/coverage-summary.json', 'utf8'));
              const total = coverage.total;
              
              coverageComment = `
              ## ðŸ“Š Coverage Report
              
              | Metric | Percentage | Covered/Total |
              |--------|------------|---------------|
              | Lines | ${total.lines.pct}% | ${total.lines.covered}/${total.lines.total} |
              | Branches | ${total.branches.pct}% | ${total.branches.covered}/${total.branches.total} |
              | Functions | ${total.functions.pct}% | ${total.functions.covered}/${total.functions.total} |
              | Statements | ${total.statements.pct}% | ${total.statements.covered}/${total.statements.total} |
              `;
            } catch (error) {
              coverageComment = '## ðŸ“Š Coverage Report\n\nCoverage report not available.';
            }

            const comment = `
            ## ðŸš€ Quality Check Results

            ### Changed Files
            ${{ steps.changed-files.outputs.all_changed_files }}

            ${coverageComment}

            ### Status
            - âœ… Linting: Passed
            - âœ… Formatting: Passed  
            - âœ… Type Check: Passed
            - âœ… Tests: Passed

            *This comment was automatically generated by the Quality Check workflow.*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: moderate

  size-limit:
    name: Bundle Size Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build and check bundle size
        run: |
          npm run build
          npx bundlesize
