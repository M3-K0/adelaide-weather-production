# Pact Contract Testing - Quick Start Guide

## üöÄ Get Started in 5 Minutes

### Prerequisites

- Node.js 18+
- npm or yarn
- Python 3.9+ (for provider tests)

### Frontend Developer Quick Start

#### 1. Install Dependencies

```bash
cd frontend
npm install
```

#### 2. Run Consumer Tests

```bash
# Generate contract files
npm run test:pact:consumer

# View generated contracts
ls pacts/
```

#### 3. Start Mock Server

```bash
# Start mock server on port 8089
npm run test:pact:mock
```

#### 4. Develop Against Mock API

```bash
# In another terminal
npm run dev

# Your frontend now uses: http://localhost:8089
```

### Backend Developer Quick Start

#### 1. Install Dependencies

```bash
cd api
pip install -r requirements.txt
```

#### 2. Run Provider Tests

```bash
# Verify API against contracts
python -m pytest pact/provider/test_provider.py -v
```

#### 3. Test Integration

```bash
# Start your API
python main.py &

# Run integration tests
cd ../frontend && npm run test:integration
```

## üß™ Common Commands

### Frontend (Consumer)

```bash
# Run all contract tests
npm run test:contract

# Generate contracts only
npm run test:pact:consumer

# Start mock server
npm run test:pact:mock

# Publish contracts (main branch)
npm run test:pact:publish
```

### Backend (Provider)

```bash
# Verify provider against contracts
python -m pytest pact/provider/ -v

# Run with specific contract file
python -m pytest pact/provider/ --pact-urls=../frontend/pacts/contract.json

# Generate verification report
python -m pytest pact/provider/ --junit-xml=verification-report.xml
```

## üìã Testing Scenarios

### Test Forecast Endpoint

```javascript
// Consumer test example
it('returns forecast with enhanced schema', async () => {
  const response = await api.get('/forecast', {
    params: { horizon: '24h', vars: 't2m,u10,v10,msl' },
    headers: { Authorization: 'Bearer test-api-token' }
  });

  expect(response.data).toHaveProperty('narrative');
  expect(response.data).toHaveProperty('risk_assessment');
  expect(response.data).toHaveProperty('analogs_summary');
});
```

### Test Error Scenarios

```bash
# Test invalid horizon
curl -H "Authorization: Bearer test-api-token" \
     "http://localhost:8089/forecast?horizon=invalid&vars=t2m"

# Expected: 400 Bad Request

# Test authentication failure
curl "http://localhost:8089/forecast?horizon=24h&vars=t2m"

# Expected: 401 Unauthorized
```

## üîß Configuration

### Environment Variables

```bash
# Mock server port
PACT_MOCK_PORT=8089

# Provider verification port
PACT_PROVIDER_PORT=8001

# Pact broker (optional)
PACT_BROKER_BASE_URL=http://localhost:9292
PACT_BROKER_TOKEN=your-token
```

### API Client Configuration

```javascript
// Frontend API client
const API_BASE_URL =
  process.env.NODE_ENV === 'development'
    ? 'http://localhost:8089' // Mock server
    : 'http://localhost:8000'; // Real API
```

## üêõ Troubleshooting

### Issue: Mock server won't start

```bash
# Check if port is in use
lsof -i :8089

# Kill existing process
pkill -f pact-mock

# Try different port
PACT_MOCK_PORT=8090 npm run test:pact:mock
```

### Issue: Provider tests fail

```bash
# Check if real API is running
curl http://localhost:8000/health

# Verify contract files exist
ls ../frontend/pacts/

# Run with verbose output
python -m pytest pact/provider/ -v -s
```

### Issue: Contract generation fails

```bash
# Clean old contracts
rm -rf pacts/*

# Reinstall dependencies
npm ci

# Run tests individually
npx jest pact/consumer/forecast-api.pact.test.js
```

## üìö Key Concepts

### Consumer Tests

- Define what the frontend expects from the API
- Generate contract files automatically
- Enable frontend development without backend

### Provider Tests

- Verify backend implements the contract correctly
- Use real API implementation
- Ensure compatibility with frontend expectations

### Mock Server

- Provides realistic API responses during development
- Based on contract definitions
- Supports different provider states

### Contract Files

- JSON files describing API interactions
- Generated by consumer tests
- Used by provider tests for verification

## üéØ Best Practices

### Writing Consumer Tests

```javascript
// ‚úÖ Good: Specific, realistic expectations
expect(response.data.variables.t2m).toMatchObject({
  value: expect.any(Number),
  p05: expect.any(Number),
  p95: expect.any(Number),
  confidence: expect.any(Number),
  available: true
});

// ‚ùå Bad: Overly specific values
expect(response.data.variables.t2m.value).toBe(20.5);
```

### Provider State Management

```python
# ‚úÖ Good: Clear state setup
def setup_operational_system():
    mock_adapter.forecast_with_uncertainty.return_value = {
        't2m': {'value': 20.5, 'available': True}
    }

# ‚ùå Bad: Complex, hard-to-maintain state
# (Avoid overly complex mock setups)
```

### Contract Evolution

```json
// ‚úÖ Good: Additive changes
{
  "variables": {
    "t2m": { "value": 20.5, "available": true },
    "new_field": { "value": 123, "available": true }
  }
}

// ‚ùå Bad: Breaking changes without versioning
{
  "temperature": 20.5  // Changed field name
}
```

## üîç Debugging Tips

### View Contract Contents

```bash
# Pretty print contract
cat pacts/*.json | jq .

# Check specific interaction
cat pacts/*.json | jq '.interactions[0]'
```

### Monitor Mock Server

```bash
# View mock server logs
tail -f logs/mock-server.log

# Test endpoint manually
curl -v "http://localhost:8089/health"
```

### Provider Verification Debugging

```python
# Add debugging to provider tests
import logging
logging.basicConfig(level=logging.DEBUG)

# Check provider state setup
print("Provider state:", setup_operational_system())
```

## üìñ Additional Resources

- [Pact Documentation](https://docs.pact.io/)
- [Contract Testing Strategy](../CONTRACT_TESTING_STRATEGY.md)
- [Mock Server README](./mock-server/README.md)
- [API Documentation](../../api/README.md)

## üÜò Getting Help

### Team Communication

- **Slack**: #contract-testing
- **Email**: dev-team@adelaide-weather.com
- **Wiki**: Internal development documentation

### Common Questions

**Q: When should I update contracts?**
A: Update contracts when adding new API features or changing existing behavior. Always test both consumer and provider sides.

**Q: How do I handle breaking changes?**
A: Bump API version, maintain backward compatibility period, coordinate with team on migration timeline.

**Q: Can I run tests without the mock server?**
A: Consumer tests generate contracts without external dependencies. Provider tests need a running API.

**Q: How do I debug contract mismatches?**
A: Compare generated contract with provider implementation, check provider state setup, validate test data.

---

_For detailed information, see the [Contract Testing Strategy](../CONTRACT_TESTING_STRATEGY.md) document._
